- defaults:
    link:
      relink: true

- clean: ["~"]

- create:
    - ~/.config/alacritty/themes

- link:
    ~/.zshrc:
      path: zsh/zshrc
      force: true
    ~/.config/atuin/config.toml:
      path: atuin/config.toml
      create: true
      force: true
    ~/.config/starship.toml:
      path: starship/starship.toml
      create: true
      force: true
    ~/.config/tmux/tmux.conf:
      path: tmux/tmux.conf
      create: true
      force: true
    ~/.config/alacritty/alacritty.toml:
      path: alacritty/alacritty_mac.toml
      create: true
      force: true
    ~/.config/common_wm/:
      path: macos_wm/common
      force: true
    ~/.config/sketchybar/:
      path: macos_wm/sketchybar
      force: true
    ~/.config/borders/:
      path: macos_wm/borders
      force: true
    ~/.config/yabai/:
      path: macos_wm/yabai
      force: true
    ~/.config/skhd/:
      path: macos_wm/skhd
      force: true

- shell:
    - [git submodule update --init --recursive, Installing submodules]

    - # Homebrew
      command: |
        if [[ $OSTYPE == darwin* ]] && ! which brew &>/dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
      description: Checking Homebrew installation
      quiet: true

    - # Clean up old oh-my-zsh installation (optional)
      command: |
        if [[ -d ~/.oh-my-zsh ]] && [[ -d ~/.config/zsh/plugins ]]; then
          echo "Note: oh-my-zsh detected at ~/.oh-my-zsh"
          echo "You can safely remove it with: rm -rf ~/.oh-my-zsh"
          echo "Standalone plugins are now used from ~/.config/zsh/plugins"
        fi
      description: Checking for oh-my-zsh migration
      stdout: true
      quiet: true

    - # Zsh plugins directory
      command: mkdir -p "$HOME/.config/zsh/plugins"
      description: Creating zsh plugins directory
      quiet: true

    - # Standalone zsh plugins
      command: |
        PLUGIN_DIR="$HOME/.config/zsh/plugins"

        # Clone plugin if it doesn't exist
        clone_plugin() {
          local repo=$1
          local name=$2
          if [[ ! -d "$PLUGIN_DIR/$name" ]]; then
            echo "Installing $name..."
            git clone --depth=1 "https://github.com/$repo.git" "$PLUGIN_DIR/$name"
          else
            echo "$name already installed"
          fi
        }

        clone_plugin "changyuheng/zsh-interactive-cd" "zsh-interactive-cd"
        clone_plugin "Aloxaf/fzf-tab" "fzf-tab"
        clone_plugin "MichaelAquilina/zsh-you-should-use" "you-should-use"
        clone_plugin "zsh-users/zsh-autosuggestions" "zsh-autosuggestions"
        clone_plugin "zsh-users/zsh-completions" "zsh-completions"
        clone_plugin "zsh-users/zsh-syntax-highlighting" "zsh-syntax-highlighting"
        clone_plugin "wfxr/forgit" "forgit"
      description: Installing standalone zsh plugins
      stdout: true
      stderr: true

    - # Shell utilities
      command: |
        source internal/helper.sh
        is_installed zoxide || brew install zoxide
        is_installed fzf || brew install fzf
        is_installed thefuck || brew install thefuck
        is_installed starship || brew install starship
      description: Installing shell utilities
      quiet: true

    - # Tmux
      command: |
        source internal/helper.sh
        is_installed tmux || brew install tmux
      description: Installing Tmux
      quiet: true

    - # Tmux plugins
      command: |
        if [ ! -e "$HOME/.tmux/plugins/tpm" ]; then
          git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
          # Install TPM plugins.
          # TPM requires running tmux server, as soon as `tmux start-server` does not work
          # create dump __noop session in detached mode, and kill it when plugins are installed
          tmux new -d -s __noop >/dev/null 2>&1 || true
          tmux set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.tmux/plugins"
          "$HOME"/.tmux/plugins/tpm/bin/install_plugins || true
          tmux kill-session -t __noop >/dev/null 2>&1 || true
        fi
      quiet: true

    - # Alacritty
      command: brew install --cask alacritty
      description: Installing Alacritty
      quiet: true

    - # Alacritty themes
      command: git clone https://github.com/alacritty/alacritty-theme "$HOME/.config/alacritty/themes" >/dev/null 2>&1 || true
      description: Installing Alacritty themes
      quiet: true

    - # Font
      command: brew install --cask font-hack-nerd-font
      description: Installing Hack Nerd Font
      quiet: true

    - # MacOS Window Management
      command: |
        brew tap koekeishiya/formulae
        brew install yabai skhd jq

        brew tap FelixKratz/formulae
        brew install sketchybar borders

        brew services start sketchybar

        curl -L https://github.com/kvndrsslr/sketchybar-app-font/releases/download/v2.0.50/sketchybar-app-font.ttf -o $HOME/Library/Fonts/sketchybar-app-font.ttf
        brew install --cask sf-symbols
        brew install --cask font-sf-mono
        brew install --cask font-sf-pro
      description: Installing Yabai
      quiet: true

    - # Post-yabai install
      command: |
        export DOT_SOURCE="$(pwd)"
        macos_wm/post_yabai_installation.sh
      description: Configuring Yabai
      quiet: true

    - # MacOS Optimizations
      command: |
        macos_optimizations
      description: Configuring MacOS
      quiet: true

    # Commented out because it takes too long. Only run this on a fresh install.
    # - # Brew
    #   command: brew bundle --file=Brewfile
    #   description: Installing Brew packages
    #   quiet: true
    #   stdout: true
