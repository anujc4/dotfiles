#!/bin/bash

if [[ "$(uname -m)" == "arm64" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"

  openssl="$(brew --prefix openssl@1.1)"
  export LDFLAGS="-L$openssl/lib"
  export CPPFLAGS="-I$openssl/include"
  export PATH="$openssl/bin:$PATH"
  export PKG_CONFIG_PATH="$openssl/lib/pkgconfig"
  RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1) --with-arch=arm64"
  export RUBY_CONFIGURE_OPTS

  # Dir to store manual arm binaries
  export PATH="$PATH:$HOME/.local/bin"
# else
  # These don't work on Intel Macs. Uncomment and apply only if running
  # terminal under Rosetta on an M1
  #
  # eval "$(/usr/local/homebrew/bin/brew shellenv)"
  #
  # Dir to store manual x86 binaries
  # Run terminal on Rosetta to use binaries in this path
  # export PATH="$PATH:$HOME/.local_x86/bin"
fi

# Mac OSX specific application alias.
alias studio='open -a /Applications/Android\ Studio.app'
alias rmine='open -a /Applications/RubyMine.app'
alias c='code .'
alias goland='open -a /Applications/GoLand.app'
alias fl='open -a ForkLift .'
alias tail_yabai='tail -f $HOMEBREW_PREFIX/var/log/yabai/*.log'
alias tail_sketchybar='tail -f $HOMEBREW_PREFIX/var/log/sketchybar/*.log'

export PATH="$PATH:/Applications/Visual Studio Code.app/Contents/Resources/app/bin"

FORGIT_INSTALL_DIR="/Users/$(whoami)/.oh-my-zsh/custom/plugins/forgit/bin"
if [ -d "$FORGIT_INSTALL_DIR" ]; then
  export PATH="$PATH:$FORGIT_INSTALL_DIR"
  export FORGIT_FZF_DEFAULT_OPTS
fi

# shellcheck disable=SC2155
export ANDROID_SDK_ROOT="/Users/$(whoami)/Library/Android/sdk"

alias bsl='brew services ls'
alias bsr='brew services restart'
alias bss='brew services start'
alias bsx='brew services stop'

alias gbc="git branch | grep '^\*' | cut -d' ' -f2 | pbcopy"

gopath="$(go env GOPATH)"
export PATH="$PATH:$gopath/bin"

export JAVA_HOME=/Library/Java/JavaVirtualMachines/amazon-corretto-17.jdk/Contents/Home

# Uninstallation command for Corretto https://docs.aws.amazon.com/corretto/latest/corretto-11-ug/macos-install.html
# cd /Library/Java/JavaVirtualMachines/
# sudo rm -rf amazon-corretto-17.jdk

path+=/usr/local/bin

function portscan()
{
  lsof -i :"$1"
}

function rsp()
{
  RACK_SERVICE_TIMEOUT=0 bundle exec rspec ./spec/"$1"
}

alias wip='git add . && git commit -m "WIP Commit"'

function wip_unset()
{
  local msg
  msg="$(git log -1 --pretty=%B)"
  if [ "$msg" = "WIP Commit" ]; then
    git reset HEAD~1
  else
    echo "No WIP commit found. Check your git log"
    return 1
  fi
}

alias b='bundle'
alias bi='bundle install'
alias rspec='bundle exec rspec'
alias rails='bundle exec rails'
alias rake='bundle exec rake'
alias migrate='bundle exec rails db:migrate'
alias rollback='bundle exec rails db:rollback'
alias migrate_test='bundle exec rails db:migrate RAILS_ENV=test'
alias rollback_test='bundle exec rails db:rollback RAILS_ENV=test'
alias db_reset='bundle exec rails db:drop; bundle exec rails db:create'

function securekb()
{
ioreg -l -w 0 \
    | perl -nle 'print $1 if /"kCGSSessionSecureInputPID"=(\d+)/' \
    | uniq \
    | xargs -I{} ps -p {} -o comm=
}

if [ -f "$(brew --prefix chruby)/share/chruby/chruby.sh" ]; then
  # shellcheck source=/dev/null
  source "$(brew --prefix chruby)/share/chruby/chruby.sh"
fi

if [ -f "$(brew --prefix chruby)/share/chruby/auto.sh" ]; then
  # shellcheck source=/dev/null
  source "$(brew --prefix chruby)/share/chruby/auto.sh"
fi

if [ -f "$(brew --prefix asdf)/libexec/asdf.sh" ]; then
  # shellcheck source=/dev/null
  source "$(brew --prefix asdf)/libexec/asdf.sh"
fi

function suyabai () {
  SHA256=$(shasum -a 256 "$(brew --prefix yabai)" | awk "{print \$1;}")
  if [ -f "/private/etc/sudoers.d/yabai" ]; then
    sudo sed -i '' -e 's/sha256:[[:alnum:]]*/sha256:'"${SHA256}"'/' /private/etc/sudoers.d/yabai
  else
    echo "sudoers file does not exist yet"
  fi
}
